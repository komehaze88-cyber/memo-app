# ユーザー指定フォントファイル対応（仕様案 / 実装プラン）

## 目的

- ユーザーが指定したフォントファイル（ローカル）をアプリ内で使用できるようにする
- OS依存の「インストール済みフォント」前提ではなく、アプリの設定として再現可能にする
- ネットワーク不要（Google Fonts等が使えない環境でも崩れない）な見た目のカスタマイズを可能にする

## 背景（現状）

- `index.html` で Google Fonts（BIZ系）を読み込んでいる
- `src/App.css` の `--font-sans` がアプリ全体の基本フォントになっている
- エディタは `.ProseMirror { font-family: var(--font-sans); }` で表示される
- 一部（例: `.cm-comment`）が特定フォント名を直書きしている

## スコープ

### 対象（MVP）

- ユーザーが選んだフォントファイルを「エディタ表示（ProseMirror）」に適用できる
- 設定として永続化でき、アプリ再起動後も同じフォントが適用される
- 失敗時は安全にフォールバック（システムフォントへ戻す）する

### 将来拡張（後続フェーズ）

- UI全体（サイドバー/ボタン/リスト）にも適用
- モノスペース領域（Rawテキスト、コードブロック、コメント等）を別設定で指定
- ウェイト（Regular/Bold）やイタリックのマッピング（複数ファイル）に対応

## 用語

- **インストール（取り込み）**: ユーザーが選択したフォントファイルを、アプリ管理領域にコピーして管理すること
- **適用**: CSS（`@font-face` / CSS変数）を更新して表示に反映すること

## 仕様

### 対応ファイル形式

- 許可拡張子: `.ttf` / `.otf` / `.woff` / `.woff2`
- 非対応（MVP）: `.ttc`（フォントコレクション）、圧縮アーカイブ、URL指定
- サイズ上限（例）: 50MB（超える場合はエラー）

### 取り込み（インストール）方針

ユーザーが指定したファイルパスをそのまま参照せず、アプリ側でコピーして管理する。

- コピー先: `AppDataDir/fonts/`（Tauriのアプリデータ領域）
- 保存ファイル名: `uuid + 元拡張子`（例: `3f...c2.woff2`）
- 重複排除（任意）: `sha256` を計算して同一バイナリを再利用できる（MVPでは後回し可）
- 取り込み後は「元の場所からフォントが消える/移動する」影響を受けない

### 設定の永続化

- 保存先（MVP）: LocalStorage（既存のZustand persistと同じ方針）
- 将来: `AppConfigDir/settings.json` に移行してもよい（バックアップ/移行が容易）

設定例（概念）:

```json
{
  "fonts": {
    "editor": { "type": "file", "id": "3f...c2", "label": "MyFont Regular" }
  },
  "installedFonts": [
    {
      "id": "3f...c2",
      "label": "MyFont Regular",
      "fileName": "3f...c2.woff2",
      "format": "woff2",
      "installedAt": 1730000000000
    }
  ]
}
```

### 適用方法（フロントエンド）

#### CSS変数の方針

- 既存の `--font-sans` を「最終的に適用されるフォントスタック」として維持する
- ユーザー指定フォントは `--font-user-sans`（仮）を経由して差し替える

例（概念）:

```css
:root {
  --font-sans: var(--font-user-sans, "BIZ UDGothic"), -apple-system,
    BlinkMacSystemFont, "Segoe UI", "Noto Sans CJK JP", "Noto Sans JP",
    "Noto Sans", Helvetica, Arial, sans-serif;
}
```

#### フォント読み込み

取り込んだフォントを `@font-face` で読み込む。

- `font-family`: 内部名ではなくアプリ側の固定エイリアス（例: `MemoUserSans`）にする
  - 同一のCSS指定で差し替えやすい
  - 内部のフォント名解析（複雑）をMVPで不要にできる
- `src`: Tauri環境でローカルファイルを参照できるURLへ変換して指定する
  - 例: `convertFileSrc(installedPath)` を使ってURL化（実装時に採用するAPIはTauri v2に合わせる）

### UI（設定画面）/ 操作フロー

#### 設定項目（MVP）

- 「エディタのフォント」
  - 現在値の表示（デフォルト / 取り込み済みフォント名）
  - `フォントファイルを選択…` ボタン
  - `デフォルトに戻す` ボタン

#### 操作フロー

1. ユーザーが `フォントファイルを選択…` を押す
2. OSファイルダイアログで `.ttf/.otf/.woff/.woff2` を選ぶ
3. バックエンドが拡張子/サイズを検証し、`AppDataDir/fonts/` にコピーする
4. フロントエンドが `@font-face` を注入し、`--font-user-sans` を `MemoUserSans` に切り替える（デフォルトに戻す場合は `--font-user-sans` を削除してフォールバックに戻す）
5. 設定を永続化し、以後はアプリ起動時に同じ手順で自動適用する

### エラーハンドリング

- 未対応拡張子: 明確なエラー（「.ttf/.otf/.woff/.woff2のみ対応」）
- コピー失敗（権限/IO）: エラー表示 + 設定は変更しない
- 起動時にフォントが見つからない（削除等）:
  - フォールバックしてデフォルト表示
  - 設定画面に警告（「取り込み済みフォントが見つかりません。再選択してください」）

## セキュリティ / プライバシー / ライセンス

- フォントはユーザーのローカルファイルのみを対象にし、URL指定や自動ダウンロードはしない
- 取り込んだフォントはアプリのデータ領域に保存し、外部送信しない
- パストラバーサル対策として、保存ファイル名にユーザー入力（元ファイル名）を使わず `uuid` を用いる
- 設定に「元のフルパス」を保存しない（保存する場合はユーザーが理解した上で明示的にオンにする）
- フォントパーサ/レンダラの脆弱性リスクはゼロにできないため、信頼できるフォントのみを選ぶ注意をUI/ドキュメントで促す（MVPは注意書きで対応）
- ライセンス:
  - フォントは配布物に同梱せず、ユーザーが自分で持ち込む前提
  - ただし「アプリデータ領域にコピーされる」ため、ユーザーがデータを共有するとフォントも共有され得る点を明記する

## 実装プラン（段階）

### Phase 0（ドキュメント整備）

- 本ドキュメントをベースに、MVPの対象範囲を確定する（UI全体か、エディタのみか）
- 既存のGoogle Fonts依存を「デフォルトのまま残す/削る」を決める

### Phase 1（MVP: エディタのみ）

- 設定UI追加（「エディタのフォント」）
- `pick_font_file` 相当のTauriコマンド追加（ファイル選択）
- `install_font` 相当のTauriコマンド追加（検証 + `AppDataDir/fonts/` へコピー）
- フロントで `@font-face` 注入 + CSS変数差し替え
- 永続化 + 起動時自動適用

### Phase 2（UI全体 + モノスペース分離）

- `--font-sans`（UI/本文）と `--font-mono`（Raw/コード）を設定で分離
- 直書きフォント（例: `.cm-comment`）を変数参照に寄せる

### Phase 3（複数ウェイト/ファミリー）

- Regular/Bold/Italic の複数ファイル対応
- フォント名/ウェイトのメタ取得（必要ならRust側で解析 or まずはユーザー入力）

## 受け入れ条件（MVP）

- フォントファイル選択後、エディタ表示のフォントが即時に変わる
- 再起動後も同じフォントが適用される
- フォントが読み込めない場合でもアプリがクラッシュせず、デフォルトフォントで表示できる
